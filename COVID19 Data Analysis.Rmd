---
title: "Corona-virus Analysis of Johns Hopkins Data set"
author: "Denzil James Greenwood"
date: "`r format(Sys.Date(), '%B %d %Y')`"
output:
  pdf_document: pdf_document
    includes:
      in_header: preamble.tex
  html_document: html_document
bibliography: references.bib
csl: "american-sociological-association.csl"
---

```{r load libraries, message=FALSE, warning=FALSE, include=FALSE}

# This section loads the required libraries for the analysis
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff = 80), tidy = TRUE)

# Function to check and install missing packages
check_and_install <- function(package) {
  if (!requireNamespace(package, quietly = TRUE)) {
    install.packages(package, dependencies = TRUE)
  }
  library(package, character.only = TRUE)
}

# List of required packages
required_packages <- c(
  "caret", "cluster", "dplyr", "forcats", "formatR","ggplot2","ggthemes",
  "glmnet", "gridExtra", "htmltools", "kableExtra", "knitr",
  "leaflet", "lubridate", "purrr", "pROC", "RColorBrewer",
  "readr", "rmarkdown", "ROCR", "sf", "stringr", "tidyverse",
  "tinytex", "viridisLite"
  )

# Check and install missing packages
invisible(lapply(required_packages, check_and_install))

```

## Description of the Data Resource

The Johns Hopkins Corona-virus Resource Center established a new standard for infectious disease tracking by publicly providing pandemic data in near real-time. It began on January 22, 2020, as the COVID-19 Dashboard, operated by the Center for Systems Science and Engineering (CSSE) and the Applied Physics Laboratory. This is the data set that will be used for this analysis. The Corona-virusResource Center ceased its data collection as of March 2022. Further information can be found at <https://coronavirus.jhu.edu/>.

### Objective

The objective of this analysis is to explore the COVID-19 data set from Johns Hopkins University. The data set contains information on confirmed cases, deaths, and recoveries for countries around the world. The analysis will focus on visualizing the data, identifying trends, and gaining insights into the spread of the virus.

### Data Collection

The data set used in this analysis is sourced from the Johns Hopkins University Center for Systems Science and Engineering (JHU CSSE) COVID-19 Data Repository. We are concerned with the time series data for confirmed cases, deaths, and recoveries at the global level and for the United States. This data can be found at the following location: <https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series>.

### Data Description

The following is a list of the data sets that we downloaded from the Johns Hopkins University Center for Systems Science and Engineering (JHU CSSE) COVID-19 Data Repository:

-   global_confirmed_transformed: Time series data for confirmed COVID-19 cases at the global level.
-   global_deaths: Time series data for COVID-19 deaths at the global level.
-   global_recovered: Time series data for COVID-19 recoveries at the global level.
-   us_confirmed: Time series data for confirmed COVID-19 cases in the United States.
-   us_deaths: Time series data for COVID-19 deaths in the United States.

```{r Downloading the data from GitHub, fig.height=10.5, fig.width=8, message=FALSE, warning=FALSE, include=FALSE}

# URL path for the permalink to the raw data on GitHub is listed below. 
# I had to remove the tree section from the link to get it to download the csv files. 
# https://raw.githubusercontent.com/CSSEGISandData/COVID-19/tree/4360e50239b4eb6b22f3a1759323748f36752177/csse_covid_19_data/csse_covid_19_time_series
raw_url <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/4360e50239b4eb6b22f3a1759323748f36752177/csse_covid_19_data/csse_covid_19_time_series/"
# File names
file_names <-
  c(  "time_series_covid19_confirmed_global.csv",
      "time_series_covid19_deaths_global.csv",
      "time_series_covid19_recovered_global.csv",
      "time_series_covid19_confirmed_US.csv",
      "time_series_covid19_deaths_US.csv"
      )

# Function for reading files safely
read_csv_safe <- function(url) {
  tryCatch(
    read_csv(url),
    error = function(e) {
      warning(paste("Error reading file:", c(e,url)))
      return(NULL)
    }
  )
}
# Concatenate URL and file name
urls <- str_c(raw_url,file_names)

# Read Files
global_confirmed <- read_csv_safe(urls[1])
global_deaths <- read_csv_safe(urls[2])
global_recovered <- read_csv_safe(urls[3])
us_confirmed <- read_csv_safe(urls[4])
us_deaths <- read_csv_safe(urls[5])

```

## Display the column names and the first few rows of the data sets

In this section we will review the data for consistence and usability. We will display the column names and the first few rows of each data set to get an overview of the data.

```{r Display column names and first few rows of the data sets, echo=TRUE, fig.height=10.5, fig.width=8, message=FALSE, warning=FALSE}
# Display the column names of the global_confirmed data set in a kable table
global_confirmed_table <- head(global_confirmed) %>%
  kable(caption = "Global confirmed cases data")

# Display the columns names of the global_deaths data set in a kable table
global_deaths_table <- head(global_deaths) %>%
  kable(caption = "Global deaths data")

# Display the columns names of the global_recovered data set in a kable table
global_recovered_table <- head(global_recovered) %>%
  kable(caption = "Global recovered data")

# Display the columns names of the us_confirmed data set in a kable table
us_confirmed_table <- head(us_confirmed) %>%
  kable(caption = "US confirmed cases data")

# Display the columns names of the us_deaths data set in a kable table
us_deaths_table <- head(us_deaths) %>%
  kable(caption = "US deaths data")

# Display tables
global_confirmed_table
global_deaths_table
global_recovered_table
us_confirmed_table
us_deaths_table

# Remove the tables from the output
rm(global_confirmed_table, global_deaths_table, global_recovered_table, us_confirmed_table, us_deaths_table)

```

## Data Cleaning and Transformation

We will change the Global data sets (confirmed, deaths, and recovered) to have the same columns: Province_State, Country_Region, date, cases, deaths, and recovered. We will also change the US data sets (confirmed and deaths) by renaming Long\_ to Long to match the Global data sets. The last change will be to rename Admin2 to County in the US data sets. These changes will create a common structure for all data sets.

```{r Data cleaning and transformation, echo=TRUE, fig.height=10.5, fig.width=8}
# Function to check and rename columns if necessary
check_and_rename <- function(df, old_names, new_names) {
  for (i in seq_along(old_names)) {
    if (old_names[i] %in% names(df)) {
      df <- df %>% rename(!!new_names[i] := !!old_names[i])
    }
  }
  return(df)
}

# Function to convert date column to Date type
convert_date <- function(data) {
  tryCatch(
    {
      data %>% mutate(date = as.Date(date, format = "%m/%d/%y"))
    },
    error = function(e) {
      message("Error in converting date: ", e$message)
      return(data)  # Return the original data if an error occurs
    }
  )
}

# Define the old and new column names
old_names_global <- c("Province/State", "Country/Region")
new_names_global <- c("Province_State", "Country_Region")

old_names_us <- c("Admin2", "Long_", "Admin2")
new_names_us <- c("County", "Long", "City")

# Check and rename columns in global data sets
global_confirmed <- check_and_rename(global_confirmed, old_names_global, new_names_global)
global_deaths <- check_and_rename(global_deaths, old_names_global, new_names_global)
global_recovered <- check_and_rename(global_recovered, old_names_global, new_names_global)

# Check and rename columns in US data sets
us_confirmed <- check_and_rename(us_confirmed, old_names_us, new_names_us)
us_deaths <- check_and_rename(us_deaths, old_names_us, new_names_us)

# Pivot longer to reshape the global data
global_confirmed <- global_confirmed %>%
  pivot_longer(cols = -c('Province_State', 'Country_Region', Lat, Long), names_to = 'date', values_to = 'cases') %>%
  select('Province_State', 'Country_Region', date, cases, Lat, Long)

global_deaths <- global_deaths %>%
  pivot_longer(cols = -c('Province_State', 'Country_Region', Lat, Long), names_to = 'date', values_to = 'deaths') %>%
  select(-c(Lat, Long))

global_recovered <- global_recovered %>%
  pivot_longer(cols = -c('Province_State', 'Country_Region', Lat, Long), names_to = 'date', values_to = 'recovered') %>%
  select(-c(Lat, Long))

# Pivot longer to reshape the US data
us_confirmed <- us_confirmed %>%
  pivot_longer(cols = -c(UID, iso2, iso3, code3, FIPS, County, Province_State, Country_Region, Lat, Long, Combined_Key), names_to = "date", values_to = "cases") %>%
  select(-c(UID, iso2, iso3, code3, FIPS, Lat, Long))

us_deaths <- us_deaths %>%
  pivot_longer(cols = -c(UID, iso2, iso3, code3, FIPS, County, Province_State, Country_Region, Lat, Long, Combined_Key, Population), names_to = "date", values_to = "deaths") %>%
  select(-c(UID, iso2, iso3, code3, FIPS, Lat, Long))

# Apply the date conversion function to each data frame
global_confirmed <- convert_date(global_confirmed)
global_deaths <- convert_date(global_deaths)
global_recovered <- convert_date(global_recovered)
us_confirmed <- convert_date(us_confirmed)
us_deaths <- convert_date(us_deaths)

# Combine global data
global_confirmed_deaths_joined <- global_confirmed %>%
  full_join(global_deaths, by = c("Province_State", "Country_Region", "date")) %>%
  full_join(global_recovered, by = c("Province_State", "Country_Region", "date"))

# Combine US data
us_confirmed <- us_confirmed %>%
  full_join(us_deaths, by = c("County", "Province_State", "Country_Region", "date"))

# Group US data by state and county
us_by_state <- us_confirmed %>%
  group_by(County, Province_State, Country_Region, date) %>%
  summarize(cases = sum(cases, na.rm = TRUE), deaths = sum(deaths, na.rm = TRUE), Population = max(Population, na.rm = TRUE), .groups = 'drop') %>%
  mutate(deaths_per_mill = deaths * 1000000 / Population) %>%
  filter(cases > 0, deaths > 0) %>%
  ungroup()

# Group US data by country
us_by_country_region <- us_confirmed %>%
  group_by(Country_Region, date) %>%
  summarize(cases = sum(cases, na.rm = TRUE), deaths = sum(deaths, na.rm = TRUE), Population = max(Population, na.rm = TRUE), .groups = 'drop') %>%
  mutate(deaths_per_mill = deaths * 1000000 / Population) %>%
  ungroup()

# Add new cases and new deaths to the US data
us_by_county_state <- us_by_state %>%
  arrange(date) %>%
  group_by(County, Province_State) %>%
  mutate(
    new_cases = cases - lag(cases, default = 0),
    new_deaths = deaths - lag(deaths, default = 0)
  ) %>%
  ungroup()

us_by_country <- us_by_country_region %>%
  arrange(date) %>%
  mutate(
    new_cases = cases - lag(cases, default = 0),
    new_deaths = deaths - lag(deaths, default = 0)
  )
```

### Data Transformation Summary

```{r Displaying the data in tabular format, echo=TRUE, fig.height=10.5, fig.width=8, message=FALSE, warning=FALSE}
# Display the column names of the global_confirmed data set in a kable table
global_confirmed_deaths_joined_table <- head(global_confirmed_deaths_joined) %>%
  kable(caption = "Global confirmed, recovered and death cases data.")

# Display the columns names of the global_deaths data set in a kable table
us_by_county_state_table <- head(us_by_county_state) %>%
  kable(caption = "US cases, deaths data by county and state.")

# Display tables
global_confirmed_deaths_joined_table
us_by_county_state_table

# Remove the tables from the output
rm(global_confirmed_deaths_joined_table, us_by_county_state_table)
```

## Summary of Total Cases, Deaths, and Recoveries

```{r Summary totals for global_confirmed_transfromed and US data, echo=TRUE, fig.height=10.5, fig.width=8}
# Get the total confirmed cases by 'Province_State' and 'Country_Region'
# Step 1: Get the max date for each 'Province_State' and 'Country_Region'
global_confirmed_max_date <- global_confirmed_deaths_joined %>%
  group_by(`Province_State`, `Country_Region`) %>%
  summarize(max_date = max(as.Date(date, format="%m/%d/%y")), .groups = 'drop')

# Step 2: Join the max dates with the original data to get case counts on those dates
global_confirmed_max_cases <- global_confirmed_deaths_joined %>%
  mutate(date = as.Date(date, format="%m/%d/%y")) %>%
  inner_join(global_confirmed_max_date, by = c('Province_State', 'Country_Region', 'date' = 'max_date'))

# Step 3: Summarize to get total cases by 'Province_State', 'Country_Region'
total_global_confirmed_cases <- head(global_confirmed_max_cases) %>%
  group_by(`Province_State`, `Country_Region`) %>%
  summarize(total_cases = sum(cases), .groups = 'drop') %>%
  mutate(total_cases = format(total_cases, big.mark = ","))

# Display the summary of total confirmed cases
total_global_confirmed_cases %>%
  kable("html", caption = "Total Global cases by Province_State and Country_Region.") 

# Get the total deaths by 'Province_State' and 'Country_Region'
# Step 1: Get the max date for each 'Province_State', 'Country_Region'
global_confirmed_transformed_deaths_max_date <- global_confirmed_deaths_joined %>%
  group_by(`Province_State`, `Country_Region`) %>%
  summarize(max_date = max(as.Date(date, format="%m/%d/%y")), .groups = 'drop')

# Step 2: Join the max dates with the original data to get death counts on those dates
global_confirmed_transformed_deaths_max_cases <- global_confirmed_deaths_joined %>%
  mutate(date = as.Date(date, format="%m/%d/%y")) %>%
  inner_join(global_confirmed_transformed_deaths_max_date, by = c('Province_State', 'Country_Region', 'date' = 'max_date'))

# Step 3: Summarize to get total deaths by 'Province_State', 'Country_Region'
total_deaths <- head(global_confirmed_transformed_deaths_max_cases) %>%
  group_by(`Province_State`, `Country_Region`) %>%
  summarize(total_deaths = sum(deaths), .groups = 'drop') %>%
  mutate(total_deaths = format(total_deaths, big.mark = ","))

# Display the result using kable
total_deaths %>%
  kable("html", caption = "Total Global deaths by Province_State and Country_Region.")

# Get the total recoveries by 'Province_State' and 'Country_Region'
# Step 1: Get the max recovered value and its corresponding date for each 'Province_State', 'Country_Region'
# Filter groups where 'recovered' has non-missing values
global_confirmed_transformed_recovered_max <- head(global_confirmed_deaths_joined) %>%
  group_by(Province_State, Country_Region) %>%
  filter(!all(is.na(recovered))) %>%
  filter(recovered == max(recovered, na.rm = TRUE)) %>%
  summarize(
    last_reported_recovered_value = max(recovered, na.rm = TRUE),
    last_reported_recovered_date = as.Date(first(date[recovered == max(recovered, na.rm = TRUE)])),
    .groups = 'drop'
  )

# Display the result using kable
global_confirmed_transformed_recovered_max %>%
  mutate(last_reported_recovered_value = format(last_reported_recovered_value, big.mark = ",")) %>%
  kable("html", caption = "Total Global recovered by Province_State and Country_Region.")

# Get the total cases, deaths, and recoveries for the US
# Step 1: Get the max date for each 'Province_State', 'Country_Region'
us_by_county_state_max_date <- us_by_county_state %>%
  group_by(`Province_State`, `Country_Region`) %>%
  summarize(max_date = max(as.Date(date, format="%m/%d/%y")), .groups = 'drop')

# Step 2: Join the max dates with the original data to get case counts on those dates
us_by_county_state_max_cases <- us_by_county_state %>%
  mutate(date = as.Date(date, format="%m/%d/%y")) %>%
  inner_join(us_by_county_state_max_date, by = c('Province_State', 'Country_Region', 'date' = 'max_date'))

# Step 3: Summarize to get total cases, deaths, and recoveries by 'Province_State', 'Country_Region'
total_us_cases_deaths <- head(us_by_county_state_max_cases) %>%
  group_by(`Province_State`, `Country_Region`) %>%
  summarize(
    total_cases = sum(cases),
    total_deaths = sum(deaths),
    .groups = 'drop'
  ) %>%
  mutate(
    total_cases = format(total_cases, big.mark = ","),
    total_deaths = format(total_deaths, big.mark = ",")
  )

# Display the result using kable
total_us_cases_deaths %>%
  kable("html", caption = "Total U.S. cases and deaths by Province_State and Country_Region.")

# Remove the tables from the output
rm(total_global_confirmed_cases, total_deaths, global_confirmed_transformed_recovered_max, total_us_cases_deaths)
```


